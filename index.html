<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxoMaster Pro - Sistema ERP Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Mantenha todos os estilos CSS originais aqui */
        /* ... (todo o CSS permanece exatamente igual) ... */
    </style>
</head>
<body>
    <!-- Decorações de fundo -->
    <div class="bg-decoration bg-circle-1"></div>
    <div class="bg-decoration bg-circle-2"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-network"></i>
                </div>
                <div>
                    <div class="logo-text">FluxoMaster</div>
                    <div class="logo-subtext">ERP PREMIUM</div>
                </div>
            </div>
        </div>
        
        <div class="user-profile">
            <div class="user-avatar" id="avatar-container" onclick="openAvatarModal()">
                <div class="avatar-placeholder">
                    <i class="fas fa-user" id="avatar-icon"></i>
                </div>
                <input type="file" id="avatar-input" accept="image/*">
            </div>
            <div class="user-info">
                <div class="user-name" id="user-name">Administrador</div>
                <div class="user-role">Plano Premium</div>
                <div class="user-status">
                    <div class="status-dot"></div>
                    <span id="connection-status">Conectando...</span>
                </div>
            </div>
        </div>
        
        <ul class="nav-list">
            <li class="nav-item active" onclick="showSection('dash')">
                <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                <div class="nav-text">Dashboard</div>
                <div class="nav-badge" id="dashboard-badge">VIP</div>
            </li>
            <li class="nav-item" onclick="showSection('clientes')">
                <div class="nav-icon"><i class="fas fa-users"></i></div>
                <div class="nav-text">Clientes</div>
                <div class="nav-badge" id="clientes-badge">0</div>
            </li>
            <li class="nav-item" onclick="showSection('financeiro')">
                <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="nav-text">Financeiro</div>
                <div class="nav-badge" id="financeiro-badge">0</div>
            </li>
            <li class="nav-item" onclick="showSection('categorias')">
                <div class="nav-icon"><i class="fas fa-tags"></i></div>
                <div class="nav-text">Categorias</div>
                <div class="nav-badge" id="categorias-badge">0</div>
            </li>
            <li class="nav-item" onclick="showSection('relatorios')">
                <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="nav-text">Relatórios</div>
                <div class="nav-badge">NEW</div>
            </li>
            <li class="nav-item" onclick="showSection('configuracoes')">
                <div class="nav-icon"><i class="fas fa-cogs"></i></div>
                <div class="nav-text">Configurações</div>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="system-info">
                <div style="font-weight: 600; color: var(--dark);">Banco de Dados</div>
                <div style="font-size: 12px; color: var(--success);" id="db-status">Conectando...</div>
            </div>
            <div class="storage-bar">
                <div class="storage-fill" id="storage-fill"></div>
            </div>
            <div class="storage-text">Supabase • Sincronização em tempo real</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div id="sec-dash" class="section">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    <div>Dashboard Premium</div>
                </div>
                <div class="header-actions">
                    <div class="date-info">
                        <i class="far fa-calendar-alt"></i>
                        <span id="current-date"></span>
                    </div>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()">
                        <i class="fas fa-plus"></i> Rápido
                    </button>
                </div>
            </div>
            
            <div class="quick-stats">
                <div class="stat-card entrada">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Total Recebido</div>
                        <div class="stat-value" id="total-in">R$ 0,00</div>
                        <div class="stat-change">
                            <i class="fas fa-calendar"></i> Este mês
                        </div>
                    </div>
                </div>
                
                <div class="stat-card saida">
                    <div class="stat-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Total Gastos</div>
                        <div class="stat-value" id="total-out">R$ 0,00</div>
                        <div class="stat-change">
                            <i class="fas fa-calendar"></i> Este mês
                        </div>
                    </div>
                </div>
                
                <div class="stat-card saldo">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Saldo Atual</div>
                        <div class="stat-value" id="total-saldo">R$ 0,00</div>
                        <div class="stat-change">
                            <i class="fas fa-chart-line"></i> Atualizado
                        </div>
                    </div>
                </div>
                
                <div class="stat-card clientes">
                    <div class="stat-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Clientes Ativos</div>
                        <div class="stat-value" id="total-clientes">0</div>
                        <div class="stat-change">
                            <i class="fas fa-user-plus"></i> Total
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-history"></i> Últimas Movimentações
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-sm" onclick="showSection('financeiro')">
                            <i class="fas fa-exchange-alt"></i> Ver Tudo
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="openAddTransactionModal()">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tab-resumo">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Fluxo</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-transactions">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-dashboard" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="empty-title">Nenhuma movimentação ainda</div>
                    <div class="empty-text">Comece adicionando sua primeira entrada ou saída financeira</div>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()">
                        <i class="fas fa-plus"></i> Adicionar Primeira Movimentação
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i> Visão Rápida do Mês
                    </div>
                    <div class="card-actions">
                        <select class="form-control" style="width: 200px;" onchange="filterDashboard(this.value)">
                            <option value="all">Todos os Períodos</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month" selected>Este Mês</option>
                            <option value="year">Este Ano</option>
                        </select>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; font-weight: 800; color: var(--primary); margin-bottom: 10px;" id="month-balance">R$ 0,00</div>
                            <div style="color: var(--gray);">Saldo do mês atual</div>
                            <div style="display: flex; justify-content: center; gap: 40px; margin-top: 30px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="month-income">R$ 0,00</div>
                                    <div style="font-size: 13px; color: var(--gray);">Entradas</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--danger);" id="month-expenses">R$ 0,00</div>
                                    <div style="font-size: 13px; color: var(--gray);">Saídas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Clientes -->
        <div id="sec-clientes" class="section" style="display:none">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-users"></i>
                    <div>Gestão de Clientes</div>
                </div>
                <div class="header-actions">
                    <div class="date-info">
                        <i class="fas fa-user-friends"></i>
                        <span id="client-count">0 clientes</span>
                    </div>
                    <button class="btn btn-primary" onclick="openClientModal()">
                        <i class="fas fa-user-plus"></i> Novo Cliente
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-list"></i> Todos os Clientes
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-sm" onclick="exportClientes()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="importClientes()">
                            <i class="fas fa-upload"></i> Importar
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tab-clientes">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Contato</th>
                                <th>Localização</th>
                                <th>Última Mov.</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-body">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-clientes" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="empty-title">Nenhum cliente cadastrado</div>
                    <div class="empty-text">Adicione clientes para organizar suas transações e ter um histórico completo</div>
                    <button class="btn btn-primary" onclick="openClientModal()">
                        <i class="fas fa-user-plus"></i> Adicionar Primeiro Cliente
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Financeiro -->
        <div id="sec-financeiro" class="section" style="display:none">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-money-bill-wave"></i>
                    <div>Gestão Financeira</div>
                </div>
                <div class="header-actions">
                    <div class="date-info">
                        <i class="far fa-clock"></i>
                        <span>Atualizado: <span id="last-update">Agora</span></span>
                    </div>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()">
                        <i class="fas fa-plus"></i> Nova Movimentação
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-filter"></i> Filtros Avançados
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-calendar"></i> Período</label>
                        <select id="filter-period" class="form-control" onchange="toggleCustomDateRange()">
                            <option value="all">Todo Período</option>
                            <option value="today">Hoje</option>
                            <option value="week">Última Semana</option>
                            <option value="month" selected>Este Mês</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div class="input-group" id="custom-date-range" style="display: none;">
                        <label class="input-label"><i class="fas fa-calendar-alt"></i> Período Personalizado</label>
                        <div class="date-range-inputs">
                            <input type="date" id="filter-date-from" class="form-control">
                            <span>até</span>
                            <input type="date" id="filter-date-to" class="form-control">
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-exchange-alt"></i> Tipo</label>
                        <select id="filter-type" class="form-control">
                            <option value="all">Todos os Tipos</option>
                            <option value="Entrada">Apenas Entradas</option>
                            <option value="Saída">Apenas Saídas</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-tag"></i> Categoria</label>
                        <select id="filter-category" class="form-control">
                            <option value="all">Todas Categorias</option>
                            <!-- Preenchido via JavaScript -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-user"></i> Cliente</label>
                        <select id="filter-client" class="form-control">
                            <option value="all">Todos Clientes</option>
                            <!-- Preenchido via JavaScript -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-sort-amount-down"></i> Ordenar por</label>
                        <select id="filter-sort" class="form-control">
                            <option value="date-desc">Data (Mais Recente)</option>
                            <option value="date-asc">Data (Mais Antiga)</option>
                            <option value="value-desc">Valor (Maior)</option>
                            <option value="value-asc">Valor (Menor)</option>
                        </select>
                    </div>
                    <div class="input-group" style="align-self: flex-end;">
                        <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-exchange-alt"></i> Todas as Movimentações
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-sm" onclick="printTransactions()">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="exportTransactions()">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tab-financas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-body">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-transactions" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="empty-title">Nenhuma movimentação encontrada</div>
                    <div class="empty-text">Tente ajustar os filtros ou adicione uma nova movimentação</div>
                    <button class="btn btn-primary" onclick="openAddTransactionModal()">
                        <i class="fas fa-plus"></i> Adicionar Movimentação
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Categorias -->
        <div id="sec-categorias" class="section" style="display:none">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-tags"></i>
                    <div>Gestão de Categorias</div>
                </div>
                <div class="header-actions">
                    <div class="date-info">
                        <i class="fas fa-hashtag"></i>
                        <span id="categoria-count">0 categorias</span>
                    </div>
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        <i class="fas fa-plus"></i> Nova Categoria
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-palette"></i> Personalize suas Categorias
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline btn-sm" onclick="resetDefaultCategories()">
                            <i class="fas fa-redo"></i> Restaurar Padrão
                        </button>
                    </div>
                </div>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-filter"></i> Filtrar por Tipo</label>
                        <select id="filter-category-type" class="form-control" onchange="filterCategories()">
                            <option value="all">Todas as Categorias</option>
                            <option value="Entrada">Apenas Entradas</option>
                            <option value="Saída">Apenas Saídas</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-search"></i> Buscar Categoria</label>
                        <input type="text" class="form-control" placeholder="Digite para buscar..." onkeyup="searchCategories(this.value)">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-list"></i> Categorias Cadastradas
                    </div>
                </div>
                <div class="table-container">
                    <table id="tab-categorias">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th>Cor</th>
                                <th>Transações</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="categories-body">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-categories" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="empty-title">Nenhuma categoria cadastrada</div>
                    <div class="empty-text">Crie categorias para organizar melhor suas transações financeiras</div>
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        <i class="fas fa-plus"></i> Criar Primeira Categoria
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Relatórios -->
        <div id="sec-relatorios" class="section" style="display:none">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-chart-pie"></i>
                    <div>Relatórios Analíticos</div>
                </div>
                <div class="header-actions">
                    <div class="date-info">
                        <i class="fas fa-calendar"></i>
                        <span id="report-period-label">Este Mês</span>
                    </div>
                    <button class="btn btn-primary" onclick="generatePDFReport()">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i> Gráfico de Movimentações
                    </div>
                    <div class="card-actions">
                        <div class="chart-filter-container">
                            <div class="chart-filter-group">
                                <select class="form-control" id="chart-period" onchange="updateChart()">
                                    <option value="daily">Diário</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly" selected>Mensal</option>
                                    <option value="yearly">Anual</option>
                                    <option value="custom">Período Personalizado</option>
                                </select>
                                <div id="chart-custom-range" class="date-range-inputs" style="display: none;">
                                    <input type="date" id="chart-date-from" class="form-control">
                                    <span>até</span>
                                    <input type="date" id="chart-date-to" class="form-control">
                                </div>
                            </div>
                            <div class="chart-type-buttons">
                                <button class="chart-type-btn active" onclick="changeChartType('bar')">Barras</button>
                                <button class="chart-type-btn" onclick="changeChartType('line')">Linhas</button>
                                <button class="chart-type-btn" onclick="changeChartType('pie')">Pizza</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="transactions-chart"></canvas>
                </div>
                <div class="chart-summary">
                    <div class="chart-summary-card">
                        <div class="chart-summary-value" id="chart-total-income">R$ 0,00</div>
                        <div class="chart-summary-label" style="color: var(--success);">Total Entradas</div>
                    </div>
                    <div class="chart-summary-card">
                        <div class="chart-summary-value" id="chart-total-expenses">R$ 0,00</div>
                        <div class="chart-summary-label" style="color: var(--danger);">Total Saídas</div>
                    </div>
                    <div class="chart-summary-card">
                        <div class="chart-summary-value" id="chart-balance">R$ 0,00</div>
                        <div class="chart-summary-label" style="color: var(--primary);">Saldo Líquido</div>
                    </div>
                    <div class="chart-summary-card">
                        <div class="chart-summary-value" id="chart-transaction-count">0</div>
                        <div class="chart-summary-label" style="color: var(--info);">Total Transações</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-table"></i> Análise por Categoria
                    </div>
                </div>
                <div class="table-container">
                    <table id="tab-relatorios">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                                <th>% do Total</th>
                            </tr>
                        </thead>
                        <tbody id="report-body">
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-report" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="empty-title">Sem dados para análise</div>
                    <div class="empty-text">Adicione transações para gerar relatórios analíticos</div>
                </div>
            </div>
        </div>
        
        <!-- Configurações -->
        <div id="sec-configuracoes" class="section" style="display:none">
            <div class="page-header">
                <div class="page-title">
                    <i class="fas fa-cogs"></i>
                    <div>Configurações do Sistema</div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="backupData()">
                        <i class="fas fa-database"></i> Backup
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-user-cog"></i> Configurações de Perfil
                    </div>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-user"></i> Nome do Usuário</label>
                        <input type="text" class="form-control" id="config-username" value="Administrador">
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-envelope"></i> E-mail</label>
                        <input type="email" class="form-control" id="config-email" placeholder="seu@email.com">
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-building"></i> Empresa</label>
                        <input type="text" class="form-control" id="config-company" placeholder="Nome da sua empresa">
                    </div>
                    <div class="input-group">
                        <label class="input-label"><i class="fas fa-map-marker-alt"></i> Cidade Padrão</label>
                        <input type="text" class="form-control" id="config-city" value="Jaraguá do Sul">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-shield-alt"></i> Segurança e Dados
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4 style="margin-bottom: 20px; color: var(--dark);">Exportar Dados</h4>
                            <p style="color: var(--gray); margin-bottom: 20px;">Faça backup de todos os dados do sistema</p>
                            <button class="btn btn-outline" onclick="exportAllData()">
                                <i class="fas fa-download"></i> Exportar Tudo
                            </button>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 20px; color: var(--dark);">Importar Dados</h4>
                            <p style="color: var(--gray); margin-bottom: 20px;">Restaurar dados de um backup anterior</p>
                            <button class="btn btn-outline" onclick="importAllData()">
                                <i class="fas fa-upload"></i> Importar Backup
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--gray-light);">
                        <h4 style="margin-bottom: 20px; color: var(--dark);">Zona de Perigo</h4>
                        <p style="color: var(--gray); margin-bottom: 20px;">Ações irreversíveis. Tenha cuidado!</p>
                        <button class="btn btn-danger" onclick="resetSystemWithConfirmation()">
                            <i class="fas fa-trash"></i> Limpar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Upload de Foto -->
    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Foto de Perfil</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="photo-upload" onclick="document.getElementById('avatar-file-input').click()">
                    <div class="photo-preview" id="modal-avatar-preview">
                        <div class="upload-icon">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="upload-text">Clique para selecionar uma imagem</div>
                    <div class="upload-subtext">Formatos suportados: JPG, PNG, GIF • Tamanho máximo: 5MB</div>
                    <input type="file" id="avatar-file-input" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveAvatar()">
                        <i class="fas fa-save"></i> Salvar Foto
                    </button>
                    <button class="btn btn-outline" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-danger" onclick="removeAvatar()" style="margin-left: auto;">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Cliente -->
    <div class="modal" id="client-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="client-modal-title">Novo Cliente</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="client-form">
                    <input type="hidden" id="client-id">
                    <div class="form-grid">
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-user"></i> Nome Completo *</label>
                            <input type="text" id="client-nome" class="form-control" placeholder="Nome do cliente" required>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-phone"></i> Telefone</label>
                            <input type="tel" id="client-tel" class="form-control" placeholder="(00) 00000-0000">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-envelope"></i> E-mail</label>
                            <input type="email" id="client-email" class="form-control" placeholder="cliente@email.com">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-id-card"></i> CPF/CNPJ</label>
                            <input type="text" id="client-document" class="form-control" placeholder="000.000.000-00">
                        </div>
                        <div class="input-group" style="grid-column: span 2">
                            <label class="input-label"><i class="fas fa-map-marker-alt"></i> Endereço</label>
                            <input type="text" id="client-address" class="form-control" placeholder="Rua, número, complemento">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-city"></i> Cidade</label>
                            <input type="text" id="client-city" class="form-control" value="Jaraguá do Sul">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-flag"></i> Estado</label>
                            <select id="client-state" class="form-control">
                                <option value="SC">Santa Catarina (SC)</option>
                                <option value="PR">Paraná (PR)</option>
                                <option value="RS">Rio Grande do Sul (RS)</option>
                                <option value="SP">São Paulo (SP)</option>
                                <option value="RJ">Rio de Janeiro (RJ)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-calendar"></i> Data de Cadastro</label>
                            <input type="date" id="client-date" class="form-control">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-tag"></i> Status</label>
                            <select id="client-status" class="form-control">
                                <option value="ativo" selected>Ativo</option>
                                <option value="inativo">Inativo</option>
                                <option value="potencial">Potencial</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Cliente
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Categoria -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="category-modal-title">Nova Categoria</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="form-grid">
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-tag"></i> Nome da Categoria *</label>
                            <input type="text" id="category-name" class="form-control" placeholder="Ex: Vendas, Salário, Aluguel" required>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-exchange-alt"></i> Tipo *</label>
                            <select id="category-type" class="form-control" required>
                                <option value="Entrada">Entrada (Receita)</option>
                                <option value="Saída">Saída (Despesa)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-palette"></i> Cor da Categoria</label>
                            <input type="color" id="category-color" class="form-control" value="#6C63FF">
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-percentage"></i> Orçamento Mensal (opcional)</label>
                            <input type="number" id="category-budget" class="form-control" placeholder="Valor em R$" step="0.01">
                        </div>
                        <div class="input-group" style="grid-column: span 2">
                            <label class="input-label"><i class="fas fa-align-left"></i> Descrição</label>
                            <textarea id="category-description" class="form-control" rows="3" placeholder="Descrição opcional da categoria"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Categoria
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Transação -->
    <div class="modal" id="transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="transaction-modal-title">Nova Transação</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    <input type="hidden" id="transaction-id">
                    <div class="form-grid">
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-exchange-alt"></i> Tipo *</label>
                            <select id="transaction-type" class="form-control" required onchange="updateCategoryOptions()">
                                <option value="Entrada">Entrada (Receita)</option>
                                <option value="Saída">Saída (Despesa)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-tags"></i> Categoria *</label>
                            <select id="transaction-category" class="form-control" required>
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-user"></i> Cliente</label>
                            <select id="transaction-client" class="form-control">
                                <option value="">Sem Cliente</option>
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-money-bill-wave"></i> Valor (R$) *</label>
                            <input type="number" id="transaction-value" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="input-group">
                            <label class="input-label"><i class="fas fa-calendar"></i> Data *</label>
                            <input type="date" id="transaction-date" class="form-control" required>
                        </div>
                        <div class="input-group" style="grid-column: span 2">
                            <label class="input-label"><i class="fas fa-align-left"></i> Descrição *</label>
                            <input type="text" id="transaction-description" class="form-control" placeholder="Descreva esta transação" required>
                        </div>
                        <div class="input-group" style="grid-column: span 2">
                            <label class="input-label"><i class="fas fa-sticky-note"></i> Observações</label>
                            <textarea id="transaction-notes" class="form-control" rows="3" placeholder="Observações adicionais"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Transação
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toast-title">Sucesso!</div>
            <div class="toast-message" id="toast-message">Operação realizada com sucesso.</div>
        </div>
        <button class="toast-close" onclick="hideToast()">&times;</button>
    </div>

    <script>
        // Configuração do Supabase - SUBSTITUA COM SUAS CREDENCIAIS
        const SUPABASE_URL = https://sohndywvhpxhawfofuro.supabase.co;
        const SUPABASE_ANON_KEY = sb_publishable_QzXSKMX7_PateQt7w4nRNg_a3EZ3bdH;
        
        let supabase;
        let currentEditingId = null;
        let transactionsChart = null;
        let currentChartType = 'bar';
        let currentUser = null;
        
        // Inicialização do Supabase
        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Verificar conexão
                const { data, error } = await supabase.from('transacoes').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateConnectionStatus(true);
                await checkAndCreateTables();
                await initApp();
                
            } catch (error) {
                console.error('Erro ao conectar com Supabase:', error);
                updateConnectionStatus(false);
                showToast("Erro de Conexão", "Não foi possível conectar ao banco de dados. Verifique suas credenciais.", "error");
            }
        }
        
        // Verificar e criar tabelas se necessário
        async function checkAndCreateTables() {
            try {
                // Verificar tabela de configurações
                const { data: configExists } = await supabase.from('configuracoes').select('*').limit(1);
                
                if (!configExists || configExists.length === 0) {
                    // Criar configuração padrão
                    await supabase.from('configuracoes').insert([{
                        usuario: 'Administrador',
                        empresa: 'Minha Empresa',
                        cidade: 'Jaraguá do Sul',
                        email: '',
                        avatar: null
                    }]);
                }
                
                // Verificar e criar categorias padrão
                const { data: categories } = await supabase.from('categorias').select('*');
                
                if (!categories || categories.length === 0) {
                    const defaultCategories = [
                        { nome: "Vendas", tipo: "Entrada", cor: "#4CC9A7", descricao: "Receitas de vendas" },
                        { nome: "Serviços", tipo: "Entrada", cor: "#36B5E8", descricao: "Receitas de serviços prestados" },
                        { nome: "Salários", tipo: "Saída", cor: "#FF5A5F", descricao: "Pagamento de salários" },
                        { nome: "Fornecedores", tipo: "Saída", cor: "#FFB74D", descricao: "Pagamentos a fornecedores" },
                        { nome: "Manutenção", tipo: "Saída", cor: "#6C63FF", descricao: "Custos de manutenção" },
                        { nome: "Marketing", tipo: "Saída", cor: "#FF6584", descricao: "Investimentos em marketing" },
                        { nome: "Aluguel", tipo: "Saída", cor: "#8C8CA1", descricao: "Pagamento de aluguel" }
                    ];
                    
                    await supabase.from('categorias').insert(defaultCategories);
                }
                
            } catch (error) {
                console.error('Erro ao verificar/criar tabelas:', error);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const dbStatus = document.getElementById('db-status');
            const storageFill = document.getElementById('storage-fill');
            
            if (connected) {
                statusElement.textContent = 'Conectado';
                statusElement.style.color = 'var(--success)';
                dbStatus.textContent = 'Online';
                dbStatus.style.color = 'var(--success)';
                storageFill.style.width = '100%';
                storageFill.style.background = 'var(--gradient-success)';
            } else {
                statusElement.textContent = 'Desconectado';
                statusElement.style.color = 'var(--danger)';
                dbStatus.textContent = 'Offline';
                dbStatus.style.color = 'var(--danger)';
                storageFill.style.width = '30%';
                storageFill.style.background = 'var(--gradient-danger)';
            }
        }
        
        // Inicialização da aplicação
        async function initApp() {
            updateCurrentDate();
            await renderAll();
            await loadUserSettings();
            await updateDashboardBadges();
            
            // Configurar eventos dos formulários
            document.getElementById('client-form').onsubmit = saveClient;
            document.getElementById('category-form').onsubmit = saveCategory;
            document.getElementById('transaction-form').onsubmit = saveTransaction;
            
            // Preencher data atual nos campos de data
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            document.getElementById('client-date').value = today;
            
            // Configurar datas para filtros
            document.getElementById('filter-date-from').value = today;
            document.getElementById('filter-date-to').value = today;
            document.getElementById('chart-date-from').value = today;
            document.getElementById('chart-date-to').value = today;
            
            // Carregar opções de categorias e clientes
            await updateCategoryOptions();
            await updateClientOptions();
            await updateFilterOptions();
            
            // Configurar atualização em tempo real
            setupRealtimeUpdates();
            
            // Mostrar mensagem de boas-vindas
            setTimeout(() => {
                showToast("Bem-vindo ao FluxoMaster Pro", "Sistema conectado ao Supabase!", "success");
            }, 1000);
        }
        
        // Configurar atualizações em tempo real
        function setupRealtimeUpdates() {
            // Transações
            supabase.channel('transacoes-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transacoes' }, 
                    payload => {
                        console.log('Mudança nas transações:', payload);
                        renderTransactions();
                        updateDashboard();
                    }
                )
                .subscribe();
            
            // Clientes
            supabase.channel('clientes-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clientes' }, 
                    payload => {
                        console.log('Mudança nos clientes:', payload);
                        renderClientes();
                        updateClientOptions();
                        updateFilterOptions();
                    }
                )
                .subscribe();
            
            // Categorias
            supabase.channel('categorias-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'categorias' }, 
                    payload => {
                        console.log('Mudança nas categorias:', payload);
                        renderCategories();
                        updateCategoryOptions();
                        updateFilterOptions();
                    }
                )
                .subscribe();
        }
        
        // Atualizar data atual
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR', options);
        }
        
        // Navegação entre seções
        function showSection(id) {
            // Esconder todas as seções
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            // Remover classe ativa de todos os itens de navegação
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Mostrar seção selecionada
            document.getElementById('sec-' + id).style.display = 'block';
            
            // Ativar item de navegação correspondente
            document.querySelector(`.nav-item[onclick="showSection('${id}')"]`).classList.add('active');
            
            // Atualizar dados específicos da seção
            if (id === 'relatorios') {
                generateReport();
                updateChart();
            }
            
            // Atualizar badges
            updateDashboardBadges();
        }
        
        // Renderizar todos os dados
        async function renderAll() {
            await updateDashboard();
            await renderClientes();
            await renderTransactions();
            await renderCategories();
            await updateFilterOptions();
        }
        
        // Atualizar badges da sidebar
        async function updateDashboardBadges() {
            try {
                // Atualizar badge de clientes
                const { count: clientCount } = await supabase.from('clientes').select('*', { count: 'exact', head: true });
                document.getElementById('clientes-badge').textContent = clientCount || 0;
                document.getElementById('total-clientes').textContent = clientCount || 0;
                
                // Atualizar badge de transações
                const { count: transactionCount } = await supabase.from('transacoes').select('*', { count: 'exact', head: true });
                document.getElementById('financeiro-badge').textContent = transactionCount || 0;
                
                // Atualizar badge de categorias
                const { count: categoryCount } = await supabase.from('categorias').select('*', { count: 'exact', head: true });
                document.getElementById('categorias-badge').textContent = categoryCount || 0;
                document.getElementById('categoria-count').textContent = (categoryCount || 0) + ' categorias';
                
            } catch (error) {
                console.error('Erro ao atualizar badges:', error);
            }
        }
        
        // ========== DASHBOARD ==========
        async function updateDashboard() {
            try {
                const dashboardBody = document.getElementById('dashboard-transactions');
                const emptyDashboard = document.getElementById('empty-dashboard');
                
                // Buscar transações recentes (últimas 10)
                const { data: recentTransactions } = await supabase
                    .from('transacoes')
                    .select('*')
                    .order('data', { ascending: false })
                    .limit(10);
                
                // Calcular totais
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Buscar todas as transações do mês atual
                const { data: monthTransactions } = await supabase
                    .from('transacoes')
                    .select('*')
                    .gte('data', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`)
                    .lte('data', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-31`);
                
                let totalIncome = 0;
                let totalExpenses = 0;
                let monthIncome = 0;
                let monthExpenses = 0;
                
                if (monthTransactions) {
                    monthTransactions.forEach(transaction => {
                        if (transaction.tipo === 'Entrada') {
                            totalIncome += parseFloat(transaction.valor) || 0;
                            monthIncome += parseFloat(transaction.valor) || 0;
                        } else {
                            totalExpenses += parseFloat(transaction.valor) || 0;
                            monthExpenses += parseFloat(transaction.valor) || 0;
                        }
                    });
                }
                
                const balance = totalIncome - totalExpenses;
                const monthBalance = monthIncome - monthExpenses;
                
                // Atualizar estatísticas
                document.getElementById('total-in').textContent = formatCurrency(totalIncome);
                document.getElementById('total-out').textContent = formatCurrency(totalExpenses);
                document.getElementById('total-saldo').textContent = formatCurrency(balance);
                document.getElementById('month-balance').textContent = formatCurrency(monthBalance);
                document.getElementById('month-income').textContent = formatCurrency(monthIncome);
                document.getElementById('month-expenses').textContent = formatCurrency(monthExpenses);
                
                // Renderizar últimas transações
                if (recentTransactions && recentTransactions.length > 0) {
                    dashboardBody.innerHTML = '';
                    recentTransactions.forEach(transaction => {
                        const isIncome = transaction.tipo === 'Entrada';
                        
                        dashboardBody.innerHTML += `
                            <tr>
                                <td>${formatDate(transaction.data)}</td>
                                <td><span class="tag ${isIncome ? 'tag-entrada' : 'tag-saida'}">${transaction.tipo}</span></td>
                                <td>${transaction.descricao}</td>
                                <td>${transaction.categoria}</td>
                                <td><strong style="color: ${isIncome ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(transaction.valor)}</strong></td>
                                <td>
                                    <button class="btn btn-warning btn-icon btn-sm" onclick="editTransaction(${transaction.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTransaction(${transaction.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    emptyDashboard.style.display = 'none';
                } else {
                    dashboardBody.innerHTML = '';
                    emptyDashboard.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
                showToast("Erro", "Não foi possível carregar o dashboard.", "error");
            }
        }
        
        function filterDashboard(period) {
            updateDashboard();
        }
        
        // ========== CLIENTES ==========
        async function renderClientes() {
            try {
                const clientesBody = document.getElementById('clientes-body');
                const emptyClientes = document.getElementById('empty-clientes');
                
                // Buscar todos os clientes
                const { data: clientes, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                clientesBody.innerHTML = '';
                
                if (clientes && clientes.length > 0) {
                    emptyClientes.style.display = 'none';
                    
                    for (const cliente of clientes) {
                        // Buscar última transação do cliente
                        const { data: lastTransaction } = await supabase
                            .from('transacoes')
                            .select('*')
                            .eq('cliente', cliente.nome)
                            .order('data', { ascending: false })
                            .limit(1)
                            .single();
                        
                        clientesBody.innerHTML += `
                            <tr>
                                <td>
                                    <div style="font-weight: 700; color: var(--dark);">${cliente.nome}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${cliente.documento || 'Sem documento'}</div>
                                </td>
                                <td>
                                    <div>${cliente.telefone || 'Não informado'}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${cliente.email || ''}</div>
                                </td>
                                <td>
                                    <div>${cliente.cidade}, ${cliente.estado}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${cliente.endereco || ''}</div>
                                </td>
                                <td>
                                    ${lastTransaction ? `
                                        <div>${formatCurrency(lastTransaction.valor)}</div>
                                        <div style="font-size: 12px; color: var(--gray);">${formatDate(lastTransaction.data)}</div>
                                    ` : 'Nenhuma transação'}
                                </td>
                                <td>
                                    <span style="
                                        padding: 4px 12px;
                                        border-radius: 20px;
                                        font-size: 12px;
                                        font-weight: 600;
                                        background: ${cliente.status === 'ativo' ? 'rgba(76, 201, 167, 0.1)' : 
                                                     cliente.status === 'inativo' ? 'rgba(255, 90, 95, 0.1)' : 
                                                     'rgba(255, 182, 77, 0.1)'};
                                        color: ${cliente.status === 'ativo' ? 'var(--success)' : 
                                                cliente.status === 'inativo' ? 'var(--danger)' : 
                                                'var(--warning)'};
                                    ">
                                        ${cliente.status === 'ativo' ? 'Ativo' : 
                                          cliente.status === 'inativo' ? 'Inativo' : 'Potencial'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-warning btn-icon btn-sm" onclick="editClient(${cliente.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon btn-sm" onclick="deleteClient(${cliente.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    emptyClientes.style.display = 'block';
                }
                
                // Atualizar contador
                document.getElementById('client-count').textContent = `${clientes?.length || 0} clientes`;
                
            } catch (error) {
                console.error('Erro ao renderizar clientes:', error);
                showToast("Erro", "Não foi possível carregar os clientes.", "error");
            }
        }
        
        async function openClientModal(clientId = null) {
            currentEditingId = clientId;
            const modal = document.getElementById('client-modal');
            const title = document.getElementById('client-modal-title');
            
            if (clientId) {
                title.textContent = 'Editar Cliente';
                
                // Carregar dados do cliente
                const { data: cliente, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', clientId)
                    .single();
                
                if (!error && cliente) {
                    document.getElementById('client-id').value = cliente.id;
                    document.getElementById('client-nome').value = cliente.nome || '';
                    document.getElementById('client-tel').value = cliente.telefone || '';
                    document.getElementById('client-email').value = cliente.email || '';
                    document.getElementById('client-document').value = cliente.documento || '';
                    document.getElementById('client-address').value = cliente.endereco || '';
                    document.getElementById('client-city').value = cliente.cidade || 'Jaraguá do Sul';
                    document.getElementById('client-state').value = cliente.estado || 'SC';
                    document.getElementById('client-date').value = cliente.dataCadastro || new Date().toISOString().split('T')[0];
                    document.getElementById('client-status').value = cliente.status || 'ativo';
                }
            } else {
                title.textContent = 'Novo Cliente';
                document.getElementById('client-form').reset();
                document.getElementById('client-id').value = '';
                document.getElementById('client-city').value = 'Jaraguá do Sul';
                document.getElementById('client-state').value = 'SC';
                document.getElementById('client-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('client-status').value = 'ativo';
            }
            
            modal.classList.add('active');
        }
        
        async function saveClient(e) {
            e.preventDefault();
            
            try {
                const cliente = {
                    nome: document.getElementById('client-nome').value,
                    telefone: document.getElementById('client-tel').value,
                    email: document.getElementById('client-email').value,
                    documento: document.getElementById('client-document').value,
                    endereco: document.getElementById('client-address').value,
                    cidade: document.getElementById('client-city').value,
                    estado: document.getElementById('client-state').value,
                    dataCadastro: document.getElementById('client-date').value,
                    status: document.getElementById('client-status').value,
                    dataAtualizacao: new Date().toISOString()
                };
                
                let result;
                
                if (currentEditingId) {
                    cliente.id = parseInt(currentEditingId);
                    result = await supabase
                        .from('clientes')
                        .update(cliente)
                        .eq('id', currentEditingId);
                } else {
                    result = await supabase
                        .from('clientes')
                        .insert([cliente]);
                }
                
                if (result.error) throw result.error;
                
                closeModal();
                await renderAll();
                await updateClientOptions();
                showToast(
                    "Cliente salvo",
                    currentEditingId ? "Cliente atualizado com sucesso!" : "Cliente cadastrado com sucesso!",
                    "success"
                );
                currentEditingId = null;
                
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                showToast("Erro", "Não foi possível salvar o cliente.", "error");
            }
        }
        
        async function editClient(id) {
            await openClientModal(id);
        }
        
        async function deleteClient(id) {
            if (confirm("Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.")) {
                try {
                    const { error } = await supabase
                        .from('clientes')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await renderAll();
                    await updateClientOptions();
                    showToast("Cliente excluído", "Cliente removido do sistema.", "success");
                    
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showToast("Erro", "Não foi possível excluir o cliente.", "error");
                }
            }
        }
        
        // Atualizar opções de clientes nos selects
        async function updateClientOptions() {
            try {
                const transactionClientSelect = document.getElementById('transaction-client');
                const filterClientSelect = document.getElementById('filter-client');
                
                // Limpar opções existentes, mantendo a primeira
                while (transactionClientSelect.options.length > 1) {
                    transactionClientSelect.remove(1);
                }
                
                while (filterClientSelect.options.length > 1) {
                    filterClientSelect.remove(1);
                }
                
                // Buscar clientes
                const { data: clientes, error } = await supabase
                    .from('clientes')
                    .select('nome')
                    .order('nome', { ascending: true });
                
                if (!error && clientes) {
                    clientes.forEach(cliente => {
                        const option1 = document.createElement('option');
                        option1.value = cliente.nome;
                        option1.textContent = cliente.nome;
                        transactionClientSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = cliente.nome;
                        option2.textContent = cliente.nome;
                        filterClientSelect.appendChild(option2);
                    });
                }
                
            } catch (error) {
                console.error('Erro ao atualizar opções de clientes:', error);
            }
        }
        
        // ========== CATEGORIAS ==========
        async function renderCategories() {
            try {
                const categoriesBody = document.getElementById('categories-body');
                const emptyCategories = document.getElementById('empty-categories');
                
                // Buscar todas as categorias
                const { data: categorias, error } = await supabase
                    .from('categorias')
                    .select('*')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                categoriesBody.innerHTML = '';
                
                if (categorias && categorias.length > 0) {
                    emptyCategories.style.display = 'none';
                    
                    for (const categoria of categorias) {
                        // Contar transações desta categoria
                        const { count: transactionCount } = await supabase
                            .from('transacoes')
                            .select('*', { count: 'exact', head: true })
                            .eq('categoria', categoria.nome);
                        
                        categoriesBody.innerHTML += `
                            <tr data-category-id="${categoria.id}">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 16px; height: 16px; border-radius: 4px; background: ${categoria.cor || '#6C63FF'}"></div>
                                        <div style="font-weight: 700; color: var(--dark);">${categoria.nome}</div>
                                    </div>
                                    ${categoria.descricao ? `<div style="font-size: 12px; color: var(--gray); margin-top: 5px;">${categoria.descricao}</div>` : ''}
                                </td>
                                <td>
                                    <span class="tag ${categoria.tipo === 'Entrada' ? 'tag-entrada' : 'tag-saida'}">
                                        ${categoria.tipo}
                                    </span>
                                </td>
                                <td>
                                    <input type="color" value="${categoria.cor || '#6C63FF'}" style="width: 40px; height: 40px; border: none; cursor: pointer;" 
                                           onchange="updateCategoryColor(${categoria.id}, this.value)" title="Clique para alterar a cor">
                                </td>
                                <td>
                                    <div style="font-weight: 700; color: var(--dark);">${transactionCount || 0}</div>
                                    <div style="font-size: 12px; color: var(--gray);">transações</div>
                                </td>
                                <td>
                                    <button class="btn btn-warning btn-icon btn-sm" onclick="editCategory(${categoria.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon btn-sm" onclick="deleteCategory(${categoria.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    emptyCategories.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Erro ao renderizar categorias:', error);
                showToast("Erro", "Não foi possível carregar as categorias.", "error");
            }
        }
        
        async function updateCategoryColor(id, color) {
            try {
                const { error } = await supabase
                    .from('categorias')
                    .update({ cor: color })
                    .eq('id', id);
                
                if (error) throw error;
                
                await renderCategories();
                showToast("Cor atualizada", "A cor da categoria foi alterada.", "success");
                
            } catch (error) {
                console.error('Erro ao atualizar cor da categoria:', error);
                showToast("Erro", "Não foi possível atualizar a cor.", "error");
            }
        }
        
        async function openCategoryModal(categoryId = null) {
            currentEditingId = categoryId;
            const modal = document.getElementById('category-modal');
            const title = document.getElementById('category-modal-title');
            
            if (categoryId) {
                title.textContent = 'Editar Categoria';
                
                // Carregar dados da categoria
                const { data: categoria, error } = await supabase
                    .from('categorias')
                    .select('*')
                    .eq('id', categoryId)
                    .single();
                
                if (!error && categoria) {
                    document.getElementById('category-id').value = categoria.id;
                    document.getElementById('category-name').value = categoria.nome || '';
                    document.getElementById('category-type').value = categoria.tipo || 'Entrada';
                    document.getElementById('category-color').value = categoria.cor || '#6C63FF';
                    document.getElementById('category-budget').value = categoria.orcamento || '';
                    document.getElementById('category-description').value = categoria.descricao || '';
                }
            } else {
                title.textContent = 'Nova Categoria';
                document.getElementById('category-form').reset();
                document.getElementById('category-id').value = '';
                document.getElementById('category-type').value = 'Entrada';
                document.getElementById('category-color').value = '#6C63FF';
            }
            
            modal.classList.add('active');
        }
        
        async function saveCategory(e) {
            e.preventDefault();
            
            try {
                const categoria = {
                    nome: document.getElementById('category-name').value,
                    tipo: document.getElementById('category-type').value,
                    cor: document.getElementById('category-color').value,
                    descricao: document.getElementById('category-description').value
                };
                
                const orcamento = document.getElementById('category-budget').value;
                if (orcamento) {
                    categoria.orcamento = parseFloat(orcamento);
                }
                
                let result;
                
                if (currentEditingId) {
                    categoria.id = parseInt(currentEditingId);
                    result = await supabase
                        .from('categorias')
                        .update(categoria)
                        .eq('id', currentEditingId);
                } else {
                    result = await supabase
                        .from('categorias')
                        .insert([categoria]);
                }
                
                if (result.error) throw result.error;
                
                closeModal();
                await renderAll();
                await updateCategoryOptions();
                await updateFilterOptions();
                showToast(
                    "Categoria salva",
                    currentEditingId ? "Categoria atualizada com sucesso!" : "Categoria criada com sucesso!",
                    "success"
                );
                currentEditingId = null;
                
            } catch (error) {
                console.error('Erro ao salvar categoria:', error);
                showToast("Erro", "Não foi possível salvar a categoria.", "error");
            }
        }
        
        async function editCategory(id) {
            await openCategoryModal(id);
        }
        
        async function deleteCategory(id) {
            if (confirm("Tem certeza que deseja excluir esta categoria? As transações associadas ficarão sem categoria.")) {
                try {
                    const { error } = await supabase
                        .from('categorias')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await renderAll();
                    await updateCategoryOptions();
                    await updateFilterOptions();
                    showToast("Categoria excluída", "Categoria removida do sistema.", "success");
                    
                } catch (error) {
                    console.error('Erro ao excluir categoria:', error);
                    showToast("Erro", "Não foi possível excluir a categoria.", "error");
                }
            }
        }
        
        function filterCategories() {
            const filterType = document.getElementById('filter-category-type').value;
            const rows = document.querySelectorAll('#categories-body tr');
            
            rows.forEach(row => {
                const typeCell = row.querySelector('td:nth-child(2)');
                const typeText = typeCell.textContent.trim();
                
                if (filterType === 'all' || 
                    (filterType === 'Entrada' && typeText === 'Entrada') ||
                    (filterType === 'Saída' && typeText === 'Saída')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function searchCategories(query) {
            const rows = document.querySelectorAll('#categories-body tr');
            
            rows.forEach(row => {
                const nameCell = row.querySelector('td:nth-child(1) div:nth-child(2)');
                const name = nameCell.textContent.toLowerCase();
                
                if (name.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        async function resetDefaultCategories() {
            if (confirm("Isso irá restaurar as categorias padrão. Suas categorias personalizadas serão mantidas. Continuar?")) {
                try {
                    // Primeiro, excluir todas as categorias
                    const { error: deleteError } = await supabase
                        .from('categorias')
                        .delete()
                        .neq('id', 0); // Excluir todas
                    
                    if (deleteError) throw deleteError;
                    
                    // Adicionar categorias padrão
                    const defaultCategories = [
                        { nome: "Vendas", tipo: "Entrada", cor: "#4CC9A7", descricao: "Receitas de vendas" },
                        { nome: "Serviços", tipo: "Entrada", cor: "#36B5E8", descricao: "Receitas de serviços prestados" },
                        { nome: "Salários", tipo: "Saída", cor: "#FF5A5F", descricao: "Pagamento de salários" },
                        { nome: "Fornecedores", tipo: "Saída", cor: "#FFB74D", descricao: "Pagamentos a fornecedores" },
                        { nome: "Manutenção", tipo: "Saída", cor: "#6C63FF", descricao: "Custos de manutenção" },
                        { nome: "Marketing", tipo: "Saída", cor: "#FF6584", descricao: "Investimentos em marketing" },
                        { nome: "Aluguel", tipo: "Saída", cor: "#8C8CA1", descricao: "Pagamento de aluguel" }
                    ];
                    
                    const { error: insertError } = await supabase
                        .from('categorias')
                        .insert(defaultCategories);
                    
                    if (insertError) throw insertError;
                    
                    await renderAll();
                    await updateCategoryOptions();
                    await updateFilterOptions();
                    showToast("Categorias restauradas", "Categorias padrão foram restauradas.", "success");
                    
                } catch (error) {
                    console.error('Erro ao restaurar categorias padrão:', error);
                    showToast("Erro", "Não foi possível restaurar as categorias padrão.", "error");
                }
            }
        }
        
        // Atualizar opções de categorias nos selects
        async function updateCategoryOptions() {
            try {
                const transactionCategorySelect = document.getElementById('transaction-category');
                const type = document.getElementById('transaction-type').value;
                
                transactionCategorySelect.innerHTML = '';
                
                // Buscar categorias do tipo selecionado
                const { data: categorias, error } = await supabase
                    .from('categorias')
                    .select('nome')
                    .eq('tipo', type)
                    .order('nome', { ascending: true });
                
                if (!error && categorias) {
                    categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        transactionCategorySelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Erro ao atualizar opções de categorias:', error);
            }
        }
        
        // ========== TRANSAÇÕES ==========
        async function renderTransactions(filteredTransactions = null) {
            try {
                const transactionsBody = document.getElementById('transactions-body');
                const emptyTransactions = document.getElementById('empty-transactions');
                
                transactionsBody.innerHTML = '';
                
                let transactions;
                
                if (filteredTransactions) {
                    transactions = filteredTransactions;
                } else {
                    // Buscar todas as transações
                    const { data: transacoes, error } = await supabase
                        .from('transacoes')
                        .select('*')
                        .order('data', { ascending: false });
                    
                    if (error) throw error;
                    transactions = transacoes;
                }
                
                if (transactions && transactions.length > 0) {
                    emptyTransactions.style.display = 'none';
                    
                    transactions.forEach(transaction => {
                        const isIncome = transaction.tipo === 'Entrada';
                        
                        transactionsBody.innerHTML += `
                            <tr>
                                <td>${formatDate(transaction.data)}</td>
                                <td><span class="tag ${isIncome ? 'tag-entrada' : 'tag-saida'}">${transaction.tipo}</span></td>
                                <td>${transaction.descricao}</td>
                                <td>${transaction.categoria}</td>
                                <td>${transaction.cliente || 'Sem cliente'}</td>
                                <td><strong style="color: ${isIncome ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(transaction.valor)}</strong></td>
                                <td>
                                    <button class="btn btn-warning btn-icon btn-sm" onclick="editTransaction(${transaction.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTransaction(${transaction.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    emptyTransactions.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Erro ao renderizar transações:', error);
                showToast("Erro", "Não foi possível carregar as transações.", "error");
            }
        }
        
        async function openAddTransactionModal(transactionId = null) {
            currentEditingId = transactionId;
            const modal = document.getElementById('transaction-modal');
            const title = document.getElementById('transaction-modal-title');
            
            if (transactionId) {
                title.textContent = 'Editar Transação';
                
                // Carregar dados da transação
                const { data: transaction, error } = await supabase
                    .from('transacoes')
                    .select('*')
                    .eq('id', transactionId)
                    .single();
                
                if (!error && transaction) {
                    document.getElementById('transaction-id').value = transaction.id;
                    document.getElementById('transaction-type').value = transaction.tipo;
                    document.getElementById('transaction-category').value = transaction.categoria;
                    document.getElementById('transaction-client').value = transaction.cliente || '';
                    document.getElementById('transaction-value').value = transaction.valor;
                    document.getElementById('transaction-date').value = transaction.data;
                    document.getElementById('transaction-description').value = transaction.descricao;
                    document.getElementById('transaction-notes').value = transaction.observacoes || '';
                    
                    await updateCategoryOptions();
                }
            } else {
                title.textContent = 'Nova Transação';
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-id').value = '';
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-type').value = 'Entrada';
                await updateCategoryOptions();
            }
            
            modal.classList.add('active');
        }
        
        async function saveTransaction(e) {
            e.preventDefault();
            
            try {
                const transaction = {
                    tipo: document.getElementById('transaction-type').value,
                    categoria: document.getElementById('transaction-category').value,
                    cliente: document.getElementById('transaction-client').value || null,
                    valor: parseFloat(document.getElementById('transaction-value').value) || 0,
                    data: document.getElementById('transaction-date').value,
                    descricao: document.getElementById('transaction-description').value,
                    observacoes: document.getElementById('transaction-notes').value,
                    dataRegistro: new Date().toISOString()
                };
                
                let result;
                
                if (currentEditingId) {
                    transaction.id = parseInt(currentEditingId);
                    result = await supabase
                        .from('transacoes')
                        .update(transaction)
                        .eq('id', currentEditingId);
                } else {
                    result = await supabase
                        .from('transacoes')
                        .insert([transaction]);
                }
                
                if (result.error) throw result.error;
                
                closeModal();
                await renderAll();
                document.getElementById('last-update').textContent = "Agora";
                showToast(
                    "Transação salva",
                    currentEditingId ? "Transação atualizada com sucesso!" : "Transação registrada com sucesso!",
                    "success"
                );
                currentEditingId = null;
                
            } catch (error) {
                console.error('Erro ao salvar transação:', error);
                showToast("Erro", "Não foi possível salvar a transação.", "error");
            }
        }
        
        async function editTransaction(id) {
            await openAddTransactionModal(id);
        }
        
        async function deleteTransaction(id) {
            if (confirm("Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.")) {
                try {
                    const { error } = await supabase
                        .from('transacoes')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await renderAll();
                    showToast("Transação excluída", "Transação removida do sistema.", "success");
                    
                } catch (error) {
                    console.error('Erro ao excluir transação:', error);
                    showToast("Erro", "Não foi possível excluir a transação.", "error");
                }
            }
        }
        
        async function updateFilterOptions() {
            try {
                // Atualizar filtro de categorias
                const categoryFilter = document.getElementById('filter-category');
                categoryFilter.innerHTML = '<option value="all">Todas Categorias</option>';
                
                // Buscar categorias
                const { data: categorias, error: catError } = await supabase
                    .from('categorias')
                    .select('nome')
                    .order('nome', { ascending: true });
                
                if (!catError && categorias) {
                    categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        categoryFilter.appendChild(option);
                    });
                }
                
                // Atualizar filtro de clientes
                const clientFilter = document.getElementById('filter-client');
                // Manter apenas a primeira opção
                while (clientFilter.options.length > 1) {
                    clientFilter.remove(1);
                }
                
                // Buscar clientes
                const { data: clientes, error: cliError } = await supabase
                    .from('clientes')
                    .select('nome')
                    .order('nome', { ascending: true });
                
                if (!cliError && clientes) {
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        option.textContent = cliente.nome;
                        clientFilter.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Erro ao atualizar opções de filtro:', error);
            }
        }
        
        async function applyFilters() {
            try {
                // Coletar todos os filtros
                const period = document.getElementById('filter-period').value;
                const type = document.getElementById('filter-type').value;
                const category = document.getElementById('filter-category').value;
                const client = document.getElementById('filter-client').value;
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                const sortOption = document.getElementById('filter-sort').value;
                
                // Construir query
                let query = supabase.from('transacoes').select('*');
                
                // Aplicar filtros
                if (type !== 'all') {
                    query = query.eq('tipo', type);
                }
                
                if (category !== 'all') {
                    query = query.eq('categoria', category);
                }
                
                if (client !== 'all') {
                    query = query.eq('cliente', client);
                }
                
                // Aplicar filtro de período
                if (period === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    query = query.eq('data', today);
                } else if (period === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    query = query.gte('data', weekAgo.toISOString().split('T')[0]);
                } else if (period === 'month') {
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    query = query.gte('data', firstDay.toISOString().split('T')[0])
                               .lte('data', lastDay.toISOString().split('T')[0]);
                } else if (period === 'custom' && dateFrom && dateTo) {
                    query = query.gte('data', dateFrom).lte('data', dateTo);
                }
                
                // Aplicar ordenação
                if (sortOption === 'date-desc') {
                    query = query.order('data', { ascending: false });
                } else if (sortOption === 'date-asc') {
                    query = query.order('data', { ascending: true });
                } else if (sortOption === 'value-desc') {
                    query = query.order('valor', { ascending: false });
                } else if (sortOption === 'value-asc') {
                    query = query.order('valor', { ascending: true });
                }
                
                // Executar query
                const { data: filteredTransactions, error } = await query;
                
                if (error) throw error;
                
                // Renderizar transações filtradas
                await renderTransactions(filteredTransactions);
                showToast("Filtros aplicados", `${filteredTransactions?.length || 0} transações encontradas.`, "success");
                
            } catch (error) {
                console.error('Erro ao aplicar filtros:', error);
                showToast("Erro", "Não foi possível aplicar os filtros.", "error");
            }
        }
        
        function clearFilters() {
            document.getElementById('filter-period').value = 'month';
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-category').value = 'all';
            document.getElementById('filter-client').value = 'all';
            document.getElementById('filter-sort').value = 'date-desc';
            document.getElementById('custom-date-range').style.display = 'none';
            renderTransactions();
            showToast("Filtros limpos", "Todos os filtros foram removidos.", "success");
        }
        
        function toggleCustomDateRange() {
            const period = document.getElementById('filter-period').value;
            const customRange = document.getElementById('custom-date-range');
            customRange.style.display = period === 'custom' ? 'block' : 'none';
        }
        
        // ========== RELATÓRIOS E GRÁFICOS ==========
        async function generateReport() {
            try {
                const reportBody = document.getElementById('report-body');
                const emptyReport = document.getElementById('empty-report');
                
                reportBody.innerHTML = '';
                
                // Buscar todas as transações
                const { data: transactions, error } = await supabase
                    .from('transacoes')
                    .select('*');
                
                if (error) throw error;
                
                if (!transactions || transactions.length === 0) {
                    emptyReport.style.display = 'block';
                    return;
                }
                
                let totalIncome = 0;
                let totalExpenses = 0;
                const categoryData = {};
                
                // Processar dados
                transactions.forEach(transaction => {
                    if (transaction.tipo === 'Entrada') {
                        totalIncome += parseFloat(transaction.valor) || 0;
                    } else {
                        totalExpenses += parseFloat(transaction.valor) || 0;
                    }
                    
                    // Agrupar por categoria
                    if (!categoryData[transaction.categoria]) {
                        categoryData[transaction.categoria] = {
                            tipo: transaction.tipo,
                            quantidade: 0,
                            valor: 0
                        };
                    }
                    
                    categoryData[transaction.categoria].quantidade++;
                    categoryData[transaction.categoria].valor += parseFloat(transaction.valor) || 0;
                });
                
                // Popular tabela de categorias
                for (const [categoria, data] of Object.entries(categoryData)) {
                    const percent = totalIncome + totalExpenses > 0 ? 
                        ((data.valor / (totalIncome + totalExpenses)) * 100).toFixed(1) : 0;
                    
                    reportBody.innerHTML += `
                        <tr>
                            <td>${categoria}</td>
                            <td><span class="tag ${data.tipo === 'Entrada' ? 'tag-entrada' : 'tag-saida'}">${data.tipo}</span></td>
                            <td>${data.quantidade}</td>
                            <td><strong>${formatCurrency(data.valor)}</strong></td>
                            <td>${percent}%</td>
                        </tr>
                    `;
                }
                
                emptyReport.style.display = 'none';
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showToast("Erro", "Não foi possível gerar o relatório.", "error");
            }
        }
        
        async function updateChart() {
            try {
                const period = document.getElementById('chart-period').value;
                const dateFrom = document.getElementById('chart-date-from').value;
                const dateTo = document.getElementById('chart-date-to').value;
                
                // Buscar transações
                let query = supabase.from('transacoes').select('*');
                
                // Filtrar por período personalizado
                if (period === 'custom' && dateFrom && dateTo) {
                    query = query.gte('data', dateFrom).lte('data', dateTo);
                }
                
                const { data: transactions, error } = await query;
                
                if (error) throw error;
                
                await processChartData(transactions || [], period);
                
            } catch (error) {
                console.error('Erro ao atualizar gráfico:', error);
                showToast("Erro", "Não foi possível atualizar o gráfico.", "error");
            }
        }
        
        async function processChartData(transactions, period) {
            let labels = [];
            let incomeData = [];
            let expensesData = [];
            let totalIncome = 0;
            let totalExpenses = 0;
            
            const now = new Date();
            
            // Agrupar dados por período
            if (period === 'daily') {
                // Últimos 30 dias
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(now.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayTransactions = transactions.filter(t => t.data === dateStr);
                    const dayIncome = dayTransactions.filter(t => t.tipo === 'Entrada').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    const dayExpenses = dayTransactions.filter(t => t.tipo === 'Saída').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    
                    labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
                    incomeData.push(dayIncome);
                    expensesData.push(dayExpenses);
                    
                    totalIncome += dayIncome;
                    totalExpenses += dayExpenses;
                }
            } else if (period === 'weekly') {
                // Últimas 12 semanas
                for (let i = 11; i >= 0; i--) {
                    const weekStart = new Date();
                    weekStart.setDate(now.getDate() - (i * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    const weekTransactions = transactions.filter(t => {
                        const date = new Date(t.data);
                        return date >= weekStart && date <= weekEnd;
                    });
                    
                    const weekIncome = weekTransactions.filter(t => t.tipo === 'Entrada').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    const weekExpenses = weekTransactions.filter(t => t.tipo === 'Saída').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    
                    labels.push(`Sem ${12-i}`);
                    incomeData.push(weekIncome);
                    expensesData.push(weekExpenses);
                    
                    totalIncome += weekIncome;
                    totalExpenses += weekExpenses;
                }
            } else if (period === 'monthly') {
                // Últimos 12 meses
                for (let i = 11; i >= 0; i--) {
                    const month = new Date();
                    month.setMonth(now.getMonth() - i);
                    
                    const monthTransactions = transactions.filter(t => {
                        const date = new Date(t.data);
                        return date.getMonth() === month.getMonth() && date.getFullYear() === month.getFullYear();
                    });
                    
                    const monthIncome = monthTransactions.filter(t => t.tipo === 'Entrada').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    const monthExpenses = monthTransactions.filter(t => t.tipo === 'Saída').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    
                    labels.push(month.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                    incomeData.push(monthIncome);
                    expensesData.push(monthExpenses);
                    
                    totalIncome += monthIncome;
                    totalExpenses += monthExpenses;
                }
            } else if (period === 'yearly') {
                // Últimos 5 anos
                for (let i = 4; i >= 0; i--) {
                    const year = now.getFullYear() - i;
                    
                    const yearTransactions = transactions.filter(t => {
                        const date = new Date(t.data);
                        return date.getFullYear() === year;
                    });
                    
                    const yearIncome = yearTransactions.filter(t => t.tipo === 'Entrada').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    const yearExpenses = yearTransactions.filter(t => t.tipo === 'Saída').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    
                    labels.push(year.toString());
                    incomeData.push(yearIncome);
                    expensesData.push(yearExpenses);
                    
                    totalIncome += yearIncome;
                    totalExpenses += yearExpenses;
                }
            } else if (period === 'custom') {
                // Período personalizado - mostrar por dia
                const dateFrom = new Date(document.getElementById('chart-date-from').value);
                const dateTo = new Date(document.getElementById('chart-date-to').value);
                const daysDiff = Math.floor((dateTo - dateFrom) / (1000 * 60 * 60 * 24));
                
                const maxDays = 30; // Limitar a 30 dias para performance
                const step = Math.max(1, Math.floor(daysDiff / maxDays));
                
                for (let i = 0; i <= daysDiff; i += step) {
                    const date = new Date(dateFrom);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayTransactions = transactions.filter(t => t.data === dateStr);
                    const dayIncome = dayTransactions.filter(t => t.tipo === 'Entrada').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    const dayExpenses = dayTransactions.filter(t => t.tipo === 'Saída').reduce((sum, t) => sum + (parseFloat(t.valor) || 0), 0);
                    
                    labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
                    incomeData.push(dayIncome);
                    expensesData.push(dayExpenses);
                    
                    totalIncome += dayIncome;
                    totalExpenses += dayExpenses;
                }
            }
            
            // Atualizar resumo
            document.getElementById('chart-total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('chart-total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('chart-balance').textContent = formatCurrency(totalIncome - totalExpenses);
            document.getElementById('chart-transaction-count').textContent = transactions.length;
            
            // Criar ou atualizar gráfico
            const ctx = document.getElementById('transactions-chart').getContext('2d');
            
            if (transactionsChart) {
                transactionsChart.destroy();
            }
            
            const chartType = currentChartType === 'pie' && period !== 'custom' && period !== 'daily' ? 'pie' : currentChartType;
            
            if (chartType === 'pie') {
                // Gráfico de pizza para resumo
                transactionsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Entradas', 'Saídas'],
                        datasets: [{
                            data: [totalIncome, totalExpenses],
                            backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--success').trim(), 
                                            getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Gráfico de barras ou linhas
                const datasetType = chartType === 'line' ? 'line' : 'bar';
                
                transactionsChart = new Chart(ctx, {
                    type: datasetType,
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Entradas',
                                data: incomeData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--success').trim(),
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--success').trim(),
                                borderWidth: datasetType === 'line' ? 3 : 1
                            },
                            {
                                label: 'Saídas',
                                data: expensesData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--danger').trim(),
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--danger').trim(),
                                borderWidth: datasetType === 'line' ? 3 : 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: datasetType === 'bar' ? {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0});
                                    }
                                }
                            }
                        } : {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0});
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Mostrar/ocultar range personalizado
            document.getElementById('chart-custom-range').style.display = period === 'custom' ? 'flex' : 'none';
        }
        
        function changeChartType(type) {
            currentChartType = type;
            
            // Atualizar botões ativos
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateChart();
        }
        
        function toggleChartCustomRange() {
            const period = document.getElementById('chart-period').value;
            const customRange = document.getElementById('chart-custom-range');
            customRange.style.display = period === 'custom' ? 'flex' : 'none';
            
            if (period === 'custom') {
                updateChart();
            }
        }
        
        // ========== CONFIGURAÇÕES ==========
        async function loadUserSettings() {
            try {
                const { data: config, error } = await supabase
                    .from('configuracoes')
                    .select('*')
                    .limit(1)
                    .single();
                
                if (!error && config) {
                    document.getElementById('user-name').textContent = config.usuario || 'Administrador';
                    document.getElementById('config-username').value = config.usuario || 'Administrador';
                    document.getElementById('config-email').value = config.email || '';
                    document.getElementById('config-company').value = config.empresa || '';
                    document.getElementById('config-city').value = config.cidade || 'Jaraguá do Sul';
                    
                    if (config.avatar) {
                        document.getElementById('avatar-container').innerHTML = `<img src="${config.avatar}" alt="Avatar">`;
                        document.getElementById('modal-avatar-preview').innerHTML = `<img src="${config.avatar}" alt="Avatar">`;
                    }
                }
                
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
            }
        }
        
        async function saveSettings() {
            try {
                const user = {
                    usuario: document.getElementById('config-username').value,
                    email: document.getElementById('config-email').value,
                    empresa: document.getElementById('config-company').value,
                    cidade: document.getElementById('config-city').value,
                    avatar: document.querySelector('#avatar-container img')?.src || null
                };
                
                // Verificar se já existe configuração
                const { data: existingConfig } = await supabase
                    .from('configuracoes')
                    .select('id')
                    .limit(1)
                    .single();
                
                let result;
                
                if (existingConfig) {
                    result = await supabase
                        .from('configuracoes')
                        .update(user)
                        .eq('id', existingConfig.id);
                } else {
                    result = await supabase
                        .from('configuracoes')
                        .insert([user]);
                }
                
                if (result.error) throw result.error;
                
                document.getElementById('user-name').textContent = user.usuario;
                showToast("Configurações salvas", "Suas configurações foram atualizadas.", "success");
                
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                showToast("Erro", "Não foi possível salvar as configurações.", "error");
            }
        }
        
        // ========== FOTO DE PERFIL ==========
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modal-avatar-preview').innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function openAvatarModal() {
            document.getElementById('avatar-modal').classList.add('active');
        }
        
        async function saveAvatar() {
            try {
                const fileInput = document.getElementById('avatar-file-input');
                
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const avatarData = e.target.result;
                        
                        // Atualizar preview
                        document.getElementById('avatar-container').innerHTML = `<img src="${avatarData}" alt="Avatar">`;
                        
                        // Salvar no banco de dados
                        const user = {
                            avatar: avatarData
                        };
                        
                        const { data: existingConfig } = await supabase
                            .from('configuracoes')
                            .select('id')
                            .limit(1)
                            .single();
                        
                        if (existingConfig) {
                            await supabase
                                .from('configuracoes')
                                .update(user)
                                .eq('id', existingConfig.id);
                        }
                        
                        closeModal();
                        showToast("Foto atualizada", "Sua foto de perfil foi salva.", "success");
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    showToast("Atenção", "Selecione uma imagem primeiro.", "error");
                }
                
            } catch (error) {
                console.error('Erro ao salvar avatar:', error);
                showToast("Erro", "Não foi possível salvar a foto.", "error");
            }
        }
        
        async function removeAvatar() {
            try {
                const user = {
                    avatar: null
                };
                
                const { data: existingConfig } = await supabase
                    .from('configuracoes')
                    .select('id')
                    .limit(1)
                    .single();
                
                if (existingConfig) {
                    await supabase
                        .from('configuracoes')
                        .update(user)
                        .eq('id', existingConfig.id);
                }
                
                document.getElementById('avatar-container').innerHTML = `
                    <div class="avatar-placeholder">
                        <i class="fas fa-user" id="avatar-icon"></i>
                    </div>
                `;
                document.getElementById('modal-avatar-preview').innerHTML = `
                    <div class="upload-icon">
                        <i class="fas fa-user"></i>
                    </div>
                `;
                closeModal();
                showToast("Foto removida", "Sua foto de perfil foi removida.", "success");
                
            } catch (error) {
                console.error('Erro ao remover avatar:', error);
                showToast("Erro", "Não foi possível remover a foto.", "error");
            }
        }
        
        // ========== BACKUP E RESTAURAÇÃO ==========
        async function backupData() {
            try {
                const allData = {};
                
                // Coletar todos os dados
                const [clientes, transacoes, categorias, configuracoes] = await Promise.all([
                    supabase.from('clientes').select('*'),
                    supabase.from('transacoes').select('*'),
                    supabase.from('categorias').select('*'),
                    supabase.from('configuracoes').select('*')
                ]);
                
                allData.clientes = clientes.data || [];
                allData.transacoes = transacoes.data || [];
                allData.categorias = categorias.data || [];
                allData.configuracoes = configuracoes.data || [];
                
                // Criar arquivo de backup
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Criar link para download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `fluxomaster_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("Backup criado", "Seus dados foram exportados com sucesso.", "success");
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showToast("Erro", "Não foi possível criar o backup.", "error");
            }
        }
        
        function exportAllData() {
            backupData();
        }
        
        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm("Isso substituirá todos os dados atuais. Tem certeza?")) {
                            // Limpar todos os dados existentes primeiro
                            await Promise.all([
                                supabase.from('clientes').delete().neq('id', 0),
                                supabase.from('transacoes').delete().neq('id', 0),
                                supabase.from('categorias').delete().neq('id', 0),
                                supabase.from('configuracoes').delete().neq('id', 0)
                            ]);
                            
                            // Inserir novos dados
                            if (data.clientes && data.clientes.length > 0) {
                                await supabase.from('clientes').insert(data.clientes);
                            }
                            
                            if (data.transacoes && data.transacoes.length > 0) {
                                await supabase.from('transacoes').insert(data.transacoes);
                            }
                            
                            if (data.categorias && data.categorias.length > 0) {
                                await supabase.from('categorias').insert(data.categorias);
                            }
                            
                            if (data.configuracoes && data.configuracoes.length > 0) {
                                await supabase.from('configuracoes').insert(data.configuracoes);
                            }
                            
                            showToast("Dados importados", "Sistema atualizado com os dados do backup.", "success");
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('Erro ao importar dados:', error);
                        showToast("Erro", "Arquivo de backup inválido.", "error");
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        async function resetSystemWithConfirmation() {
            const response = prompt("TEM CERTEZA ABSOLUTA QUE DESEJA LIMPAR TODOS OS DADOS?\n\nIsso apagará TODOS os dados: clientes, transações, categorias e configurações.\n\nDigite 'LIMPAR' para confirmar:");
            
            if (response === 'LIMPAR') {
                if (confirm("ÚLTIMA CONFIRMAÇÃO: Todos os dados serão PERDIDOS para sempre. Continuar?")) {
                    try {
                        await Promise.all([
                            supabase.from('clientes').delete().neq('id', 0),
                            supabase.from('transacoes').delete().neq('id', 0),
                            supabase.from('categorias').delete().neq('id', 0),
                            supabase.from('configuracoes').delete().neq('id', 0)
                        ]);
                        
                        // Recriar categorias padrão
                        await checkAndCreateTables();
                        
                        showToast("Sistema limpo", "Todos os dados foram removidos. Recarregando...", "success");
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Erro ao limpar dados:', error);
                        showToast("Erro", "Não foi possível limpar os dados.", "error");
                    }
                }
            } else if (response !== null) {
                showToast("Cancelado", "Limpeza do sistema cancelada.", "error");
            }
        }
        
        // ========== UTILITÁRIOS ==========
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
            currentEditingId = null;
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function showToast(title, message, type = "success") {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = toast.querySelector('.toast-icon i');
            
            toast.className = `toast toast-${type}`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            if (type === "success") {
                toastIcon.className = "fas fa-check";
            } else if (type === "error") {
                toastIcon.className = "fas fa-times";
            } else {
                toastIcon.className = "fas fa-info-circle";
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }
        
        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }
        
        // Funções auxiliares
        function printTransactions() {
            window.print();
        }
        
        function exportTransactions() {
            showToast("Exportar", "Exportando transações...", "info");
            backupData();
        }
        
        function exportClientes() {
            showToast("Exportar", "Exportando clientes...", "info");
            backupData();
        }
        
        function importClientes() {
            showToast("Importar", "Use a função de importar backup nas configurações", "info");
        }
        
        function generatePDFReport() {
            showToast("PDF", "Gerando relatório em PDF...", "info");
            // Implementação básica
            const canvas = document.getElementById('transactions-chart');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `relatorio_fluxomaster_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            showToast("PDF", "Gráfico exportado como imagem.", "success");
        }
        
        // Configurar eventos
        document.getElementById('chart-period').addEventListener('change', function() {
            toggleChartCustomRange();
            updateChart();
        });
        
        document.getElementById('chart-date-from').addEventListener('change', updateChart);
        document.getElementById('chart-date-to').addEventListener('change', updateChart);
        
        // Inicializar gráfico quando a página carregar
        window.addEventListener('load', function() {
            initSupabase();
        });
    </script>
</body>
</html>